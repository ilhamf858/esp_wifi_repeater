#include "user/oled.h"
#include "i2c_master.h"
#include <string.h>
#include <stdio.h>
#include "esp_common.h"
#include "osapi.h"

#define OLED_ADDR 0x3C
static void i2c_start() { i2c_master_start(); }
static void i2c_stop()  { i2c_master_stop();  }
static void i2c_write(uint8_t b) { i2c_master_writeByte(b); i2c_master_waitAck(); }

static void ssd1306_cmd(uint8_t cmd) {
    i2c_start();
    i2c_write((OLED_ADDR<<1) | 0x00);
    i2c_write(0x00);
    i2c_write(cmd);
    i2c_stop();
}
static void ssd1306_data(const uint8_t *data, uint16_t len) {
    i2c_start();
    i2c_write((OLED_ADDR<<1) | 0x00);
    i2c_write(0x40);
    for (uint16_t i=0;i<len;i++) i2c_write(data[i]);
    i2c_stop();
}

void oled_init(void) {
    i2c_master_gpio_init();
    const uint8_t init_seq[] = {
        0xAE,0xD5,0x80,0xA8,0x3F,0xD3,0x00,0x40,
        0x8D,0x14,0x20,0x00,0xA1,0xC8,0xDA,0x12,
        0x81,0xCF,0xD9,0xF1,0xDB,0x40,0xA4,0xA6,0xAF
    };
    for (int i=0;i<sizeof(init_seq); i++) ssd1306_cmd(init_seq[i]);
    oled_clear();
}

void oled_clear(void) {
    uint8_t zero[128];
    os_memset(zero,0,sizeof(zero));
    for (uint8_t page=0; page<8; page++) {
        ssd1306_cmd(0xB0 | page);
        ssd1306_cmd(0x00);
        ssd1306_cmd(0x10);
        ssd1306_data(zero, 128);
    }
}

// Minimal 6x8 font for a few chars (space, digits, uppercase letters A-Z, and some punctuation)
static const uint8_t font6x8[][6] = {
    {0x00,0x00,0x00,0x00,0x00,0x00}, // space
    {0x3E,0x51,0x49,0x45,0x3E,0x00}, // 0
    {0x00,0x42,0x7F,0x40,0x00,0x00}, // 1
    {0x62,0x51,0x49,0x49,0x46,0x00}, // 2
    {0x22,0x41,0x49,0x49,0x36,0x00}, // 3
    {0x18,0x14,0x12,0x7F,0x10,0x00}, // 4
    {0x2F,0x45,0x45,0x45,0x39,0x00}, // 5
    {0x3C,0x4A,0x49,0x49,0x30,0x00}, // 6
    {0x01,0x71,0x09,0x05,0x03,0x00}, // 7
    {0x36,0x49,0x49,0x49,0x36,0x00}, // 8
    {0x06,0x49,0x49,0x29,0x1E,0x00}, // 9
    // A-Z (simplified approximate patterns)
    {0x7E,0x11,0x11,0x11,0x7E,0x00}, // A
    {0x7F,0x49,0x49,0x49,0x36,0x00}, // B
    {0x3E,0x41,0x41,0x41,0x22,0x00}, // C
    {0x7F,0x41,0x41,0x22,0x1C,0x00}, // D
    {0x7F,0x49,0x49,0x49,0x41,0x00}, // E
    {0x7F,0x09,0x09,0x09,0x01,0x00}, // F
    {0x3E,0x41,0x49,0x49,0x7A,0x00}, // G
    {0x7F,0x08,0x08,0x08,0x7F,0x00}, // H
    {0x00,0x41,0x7F,0x41,0x00,0x00}, // I
    {0x20,0x40,0x41,0x3F,0x01,0x00}, // J
    {0x7F,0x08,0x14,0x22,0x41,0x00}, // K
    {0x7F,0x40,0x40,0x40,0x40,0x00}, // L
    {0x7F,0x02,0x0C,0x02,0x7F,0x00}, // M
    {0x7F,0x04,0x08,0x10,0x7F,0x00}, // N
    {0x3E,0x41,0x41,0x41,0x3E,0x00}, // O
    {0x7F,0x09,0x09,0x09,0x06,0x00}, // P
    {0x3E,0x41,0x51,0x21,0x5E,0x00}, // Q
    {0x7F,0x09,0x19,0x29,0x46,0x00}, // R
    {0x26,0x49,0x49,0x49,0x32,0x00}, // S
    {0x01,0x01,0x7F,0x01,0x01,0x00}, // T
    {0x3F,0x40,0x40,0x40,0x3F,0x00}, // U
    {0x1F,0x20,0x40,0x20,0x1F,0x00}, // V
    {0x3F,0x40,0x38,0x40,0x3F,0x00}, // W
    {0x63,0x14,0x08,0x14,0x63,0x00}, // X
    {0x07,0x08,0x70,0x08,0x07,0x00}, // Y
    {0x61,0x51,0x49,0x45,0x43,0x00}, // Z
};

void oled_draw_text(int x, int y, const char* str) {
    if (!str) return;
    int page = y / 8;
    uint8_t buf[128]; os_memset(buf,0,sizeof(buf));
    int cpos = 0;
    while (*str && cpos + 6 <= 128) {
        char ch = *str++;
        const uint8_t *glyph = font6x8[0]; // default space
        if (ch >= '0' && ch <= '9') glyph = font6x8[ch - '0'];
        else if (ch >= 'A' && ch <= 'Z') glyph = font6x8[10 + (ch - 'A')];
        // else leave as space for unsupported chars
        for (int i=0;i<6;i++) buf[cpos + i] = glyph[i];
        cpos += 6;
    }
    ssd1306_cmd(0xB0 | page);
    ssd1306_cmd(0x00);
    ssd1306_cmd(0x10);
    ssd1306_data(buf, 128);
}

void oled_show_lines(const char* l1, const char* l2, const char* l3, const char* l4) {
    oled_clear();
    oled_draw_text(0,0,l1?l1:"");
    oled_draw_text(0,8,l2?l2:"");
    oled_draw_text(0,24,l3?l3:"");
    oled_draw_text(0,40,l4?l4:"");
}

void oled_show_status(const char* ssid_up, const char* ip, int rssi, bool ap_on, bool hidden) {
    char l1[32], l2[32], l3[32], l4[32];
    os_sprintf(l1, "Up: %s", ssid_up ? ssid_up : "-");
    os_sprintf(l2, "IP: %s", ip ? ip : "-");
    os_sprintf(l3, "RSSI:%ddBm", rssi);
    os_sprintf(l4, "AP:%s %s", ap_on?"ON":"OFF", hidden?"HIDE":"");
    oled_show_lines(l1,l2,l3,l4);
}

void oled_scroll_message(const char* msg) {
    oled_clear();
    oled_draw_text(0,0,msg?msg:"");
}
